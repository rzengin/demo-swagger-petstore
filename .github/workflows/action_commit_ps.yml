name: Action on Pull Request to generate Kong Config from Spec and Validate it

on:
  push:
    branches: ["**"]

jobs:
  deploy_to_kong:
    runs-on: self-hosted
    name: Generate Kong config from Spec and Validate config
    steps:
      # - name: Checkout
      #   uses: actions/checkout@v2

      - name: Lint OpenAPI Specification
        run: inso lint spec /Users/rzengin/GitHub/demo-swagger-petstore/src/main/resources/openapi.yaml --ci

      - name: Test OpenAPI Spec
        run: inso run test Demo_Kong_Suite --env "OpenAPI env petstore3.swagger.io" --ci

      - name: Create OpenAPI Specification From Insomnia
        run:  inso export spec "Swagger-Petstore" --output gen-petstore-openapi.yaml --ci

      - name: Generate Kong declarative configuration from Spec
        run: deck file openapi2kong --spec gen-petstore-openapi.yaml --output-file petstorekong-deck.yaml --inso-compatible

      - name: Validate Kong declarative configuration
        run: deck file validate petstorekong-deck.yaml

      - name: Ping Kong Gateway Instance
        run:  deck gateway ping --konnect-token $KONNECT_TOKEN  --konnect-control-plane-name demo-local

      - name: Check differences between specificatiln file and Gateway
        run: deck gateway diff petstorekong-deck.yaml --konnect-token $KONNECT_TOKEN --konnect-control-plane-name demo-local

      - name: Deploy new configuration to Gateway
        run: deck gateway sync petstorekong-deck.yaml --konnect-token $KONNECT_TOKEN --konnect-control-plane-name demo-local
